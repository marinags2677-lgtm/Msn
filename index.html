<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Intersol Messenger - Aero Edition</title>
    <style>
        /* TEMA AERO WINDOWS 7 */
        body { 
            background: #004b8d url('https://wallpaperaccess.com/full/2157335.jpg') no-repeat center center fixed; 
            background-size: cover; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; 
            display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; 
        }

        /* BARRA DE CARGA WLM */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-bar { width: 200px; height: 12px; background: #eee; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .progress { width: 0%; height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.1s; }

        /* VENTANA PRINCIPAL AERO */
        .msn-main { 
            width: 320px; height: 580px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 8px; display: flex; flex-direction: column; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); position: relative; 
        }

        .header { 
            background: rgba(255, 255, 255, 0.2); color: #1c3d5a; padding: 12px; font-weight: bold; font-size: 13px; 
            border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;
        }
        
        .user-card { padding: 15px; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 55px; height: 55px; background: #fff; border: 1px solid #999; border-radius: 5px; padding: 2px; cursor: pointer; object-fit: cover; }
        
        .status-select { font-size: 11px; border: none; background: transparent; color: #555; cursor: pointer; outline: none; }
        .music-info { font-size: 11px; color: #0055e0; font-style: italic; cursor: pointer; display: block; margin-top: 2px; }

        .contact-list { flex-grow: 1; overflow-y: auto; padding: 10px; background: rgba(255, 255, 255, 0.8); margin: 5px; border-radius: 4px; }
        .contact { display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 4px; gap: 10px; }
        .contact:hover { background: rgba(0, 120, 212, 0.1); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
        .online { background: #31a24c; } .busy { background: #f02849; } .away { background: #f7b928; }

        /* CHAT AERO */
        #chat-window { 
            display: none; position: absolute; top: 30px; left: 340px; width: 400px; height: 480px; 
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 10px; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }
        #chat-msgs { flex-grow: 1; background: white; margin: 10px; padding: 15px; overflow-y: auto; border: 1px solid #cedee9; border-radius: 4px; }
        
        .chat-tools { padding: 5px 15px; display: flex; gap: 15px; font-size: 20px; cursor: pointer; align-items: center; border-top: 1px solid rgba(0,0,0,0.05); }
        .chat-input-area { padding: 10px 15px; display: flex; gap: 8px; background: rgba(0,0,0,0.02); }
        
        input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 3px; }
        button { background: linear-gradient(#f9f9f9, #e1e1e1); border: 1px solid #aaa; padding: 5px 15px; cursor: pointer; border-radius: 3px; }

        .hidden { display: none !important; }
        .shake { animation: shake 0.2s 5; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(5px,5px); } 50% { transform: translate(-5px,-5px); } 75% { transform: translate(5px,-5px); } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <img src="https://upload.wikimedia.org/wikipedia/commons/d/df/Windows_Live_Messenger_logo.svg" width="70">
        <div class="loader-bar"><div class="progress" id="p-bar"></div></div>
        <p style="font-size: 11px; color: #666; margin-top: 10px;">Iniciando sesi√≥n en Intersol...</p>
    </div>

    <div class="msn-main">
        <div class="header">
            <span>Windows Live Messenger</span>
            <div style="display:flex; gap:10px;">
                <span onclick="document.getElementById('script-import').click()" style="cursor:pointer" title="Importar Script">üìú</span>
                <span onclick="toggleFullscreen()" style="cursor:pointer">‚õ∂</span>
            </div>
            <input type="file" id="script-import" class="hidden" accept=".json" onchange="importarScriptReal()">
        </div>
        
        <div class="user-card">
            <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="subirAvatarPropio()">
            <img id="my-avatar" class="avatar" src="https://via.placeholder.com/55" onclick="document.getElementById('avatar-input').click()">
            <div>
                <b id="my-name" style="color:#1c3d5a;">Cargando...</b><br>
                <select id="my-status" class="status-select" onchange="cambiarEstado()">
                    <option value="online">‚óè Disponible</option>
                    <option value="busy">‚óè Ocupado</option>
                    <option value="away">‚óè Ausente</option>
                </select>
                <span class="music-info" id="my-music" onclick="ponerMusica()">üéµ Poner m√∫sica...</span>
            </div>
        </div>

        <div class="contact-list" id="users-list"></div>
        <div style="padding:8px; text-align:center; font-size:10px; color:#555; background: rgba(0,0,0,0.05);">Intersol ID Service</div>
    </div>

    <div id="chat-window">
        <div class="header" id="chat-with-name">
            <span>Conversaci√≥n</span>
            <span onclick="cerrarChat()" style="cursor:pointer">‚úñ</span>
        </div>
        <div id="chat-msgs"></div>
        
        <div class="chat-tools">
            <span onclick="enviarZumbido()" title="Zumbido">üîî</span>
            <span onclick="document.getElementById('msg-file-input').click()" title="Adjuntar">üìé</span>
            <span onclick="insertarEmoji('üòä')">üòä</span>
            <input type="file" id="msg-file-input" class="hidden" onchange="enviarArchivoChat()">
        </div>

        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Escribe un mensaje...">
            <button onclick="enviarMensaje()">Enviar</button>
        </div>
    </div>

    <audio id="snd-zumbido" src="https://www.myinstants.com/media/sounds/msn-nudge.mp3"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAWMmRpC9chHuBMWbMCRFeEzhQjh1dJ0Uw",
        databaseURL: "https://intersol-ce061-default-rtdb.firebaseio.com",
        projectId: "intersol-ce061",
        appId: "1:582674758781:web:aa6326c6d84b675c504514"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const session = JSON.parse(localStorage.getItem('intersol_user'));
    const userPath = 'intersol/usuarios/' + (session?.email?.replace(/\./g, '_') || '');

    // BARRA DE CARGA
    let p = 0;
    const interval = setInterval(() => {
        p += 15; document.getElementById('p-bar').style.width = p + "%";
        if(p >= 100) { clearInterval(interval); document.getElementById('loading-overlay').classList.add('hidden'); }
    }, 100);

    let chatActivo = null;
    let currentScript = { onMessage: [] };

    if (!session) {
        window.location.href = "hotmail.html";
    } else {
        document.getElementById('my-name').innerText = session.nombre;
        
        onValue(ref(db, userPath), (s) => {
            const val = s.val();
            if(val) {
                if(val.foto) document.getElementById('my-avatar').src = val.foto;
                if(val.status) document.getElementById('my-status').value = val.status;
                if(val.music) document.getElementById('my-music').innerText = "üéµ " + val.music;
            }
        });

        onValue(ref(db, 'intersol/usuarios'), (snap) => {
            const cont = document.getElementById('users-list');
            cont.innerHTML = "";
            snap.forEach(u => {
                const user = u.val();
                if(user.email !== session.email) {
                    const div = document.createElement('div');
                    div.className = 'contact';
                    div.innerHTML = `
                        <div style="position:relative">
                            <img src="${user.foto || 'https://via.placeholder.com/55'}" style="width:35px; height:35px; border-radius:4px; object-fit:cover;">
                            <div class="status-dot ${user.status || 'online'}" style="position:absolute; bottom:-2px; right:-2px;"></div>
                        </div>
                        <div><b>${user.nombre}</b><br><small style="color:#666; font-size:10px;">${user.music || ''}</small></div>
                    `;
                    div.onclick = () => abrirChat(user);
                    cont.appendChild(div);
                }
            });
        });
    }

    // FUNCIONES RECUPERADAS
    window.subirAvatarPropio = () => {
        const file = document.getElementById('avatar-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => update(ref(db, userPath), { foto: e.target.result });
        reader.readAsDataURL(file);
    };

    window.cambiarEstado = () => update(ref(db, userPath), { status: document.getElementById('my-status').value });

    window.ponerMusica = () => {
        const m = prompt("¬øQu√© escuchas?");
        if(m !== null) update(ref(db, userPath), { music: m });
    };

    window.importarScriptReal = () => {
        const file = document.getElementById('script-import').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const temp = JSON.parse(e.target.result);
                if(confirm(`¬øAceptar cambios del script "${temp.name || 'Intersol'}"?`)) currentScript = temp;
            } catch(err) { alert("Archivo no v√°lido"); }
        };
        reader.readAsText(file);
    };

    window.abrirChat = (user) => {
        chatActivo = user;
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('chat-with-name').children[0].innerText = "Conversando con " + user.nombre;
        cargarMensajes();
    };

    window.enviarMensaje = () => {
        const input = document.getElementById('chat-input');
        let txt = input.value;
        if(!txt || !chatActivo) return;
        currentScript.onMessage?.forEach(s => { if(txt.toLowerCase() === s.trigger.toLowerCase()) txt = s.value; });
        const chatID = [session.email, chatActivo.email].sort().join('_').replace(/\./g, '_');
        push(ref(db, 'intersol/chats/' + chatID), { user: session.nombre, text: txt, type: 'text' });
        input.value = "";
    };

    window.enviarZumbido = () => {
        const chatID = [session.email, chatActivo.email].sort().join('_').replace(/\./g, '_');
        push(ref(db, 'intersol/chats/' + chatID), { type: 'zumbido', user: session.nombre });
    };

    window.enviarArchivoChat = () => {
        const file = document.getElementById('msg-file-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const chatID = [session.email, chatActivo.email].sort().join('_').replace(/\./g, '_');
            push(ref(db, 'intersol/chats/' + chatID), { user: session.nombre, fileName: file.name, fileData: e.target.result, type: 'file' });
        };
        reader.readAsDataURL(file);
    };

    function cargarMensajes() {
        const chatID = [session.email, chatActivo.email].sort().join('_').replace(/\./g, '_');
        onValue(ref(db, 'intersol/chats/' + chatID), (snap) => {
            const box = document.getElementById('chat-msgs'); box.innerHTML = "";
            snap.forEach(m => {
                const msg = m.val();
                if(msg.type === 'zumbido') {
                    box.innerHTML += `<div style="color:red"><b>¬°Zumbido de ${msg.user}!</b></div>`;
                    if(msg.user !== session.nombre) { 
                        document.getElementById('snd-zumbido').play();
                        document.getElementById('chat-window').classList.add('shake');
                        setTimeout(() => document.getElementById('chat-window').classList.remove('shake'), 500);
                    }
                } else if(msg.type === 'file') {
                    const esImg = msg.fileData.startsWith('data:image');
                    const content = esImg ? `<img src="${msg.fileData}" style="max-width:120px; border-radius:5px;">` : `üìÅ ${msg.fileName}`;
                    box.innerHTML += `<div><b>${msg.user}:</b> <a href="${msg.fileData}" download="${msg.fileName}">${content}</a></div>`;
                } else {
                    box.innerHTML += `<div><b>${msg.user}:</b> ${msg.text}</div>`;
                }
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.cerrarChat = () => document.getElementById('chat-window').style.display = 'none';
    window.insertarEmoji = (e) => document.getElementById('chat-input').value += e;
    window.toggleFullscreen = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
    document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') enviarMensaje(); });
</script>
</body>
</html>
